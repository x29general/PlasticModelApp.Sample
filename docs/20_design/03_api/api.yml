openapi: 3.0.0
info:
  title: Plastic Model App API
  description: Plastic Model App の API ドキュメント。
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: ローカル Docker サーバー

paths:
  /healthz:
    get:
      summary: Health Check
      description: API のヘルス状態を確認します。
      tags:
        - Health
      x-number: [API-001]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  Status:
                    type: string
                    example: "ok"

  /health/db:
    get:
      summary: Database Health Check
      description: データベース接続の状態を確認します。
      tags:
        - Health
      responses:
        "200":
          description: データベース接続正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
        "503":
          description: データベース接続エラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "error"
                  message:
                    type: string

  /api/paints/search:
    post:
      summary: 塗料検索
      description: 各種条件で塗料を検索します。
      tags:
        - Paints
      x-usecases: [UC-U-01]
      x-functions: [FR001, FR002, FR003]
      x-phase: [Phase1]
      x-number: [API-003]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PaintSearchCriteria"
      responses:
        "200":
          description: 検索条件に一致する塗料の一覧。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaintListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/paints/color-search:
    post:
      summary: 類似色検索
      description: 選択された色に基づいて類似色の塗料を検索します。
      tags:
        - Paints
      x-usecases: [UC-U-03, UC-U-04]
      x-functions: [FR006, FR008]
      x-phase: [Phase2]
      x-number: [API-004]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ColorSearchCriteria"
      responses:
        "200":
          description: 選択された色に類似する塗料の一覧。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SimilarPaintListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/paints/{id}:
    get:
      summary: 塗料詳細を取得
      description: 指定した ID の塗料の詳細情報を取得します。
      tags:
        - Paints
      x-usecases: [UC-U-02]
      x-functions: [FR005]
      x-phase: [Phase1]
      x-number: [API-005]
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the paint to retrieve.
          schema:
            type: string
      responses:
        "200":
          description: 指定した塗料の詳細情報。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaintResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/masters:
    get:
      summary: マスタデータ取得
      description: ブランド、塗料タイプ、光沢レベル、タグなどのマスタデータを取得します。
      tags:
        - Masters
      x-usecases: [UC-U-01]
      x-functions: [FR001, FR002, FR003]
      x-phase: [Phase1]
      x-number: [API-002]
      responses:
        "200":
          description: ブランド、塗料タイプ、光沢レベル、タグなどを含むマスタデータ。
          content:
            application/json:
              schema:
                type: object
                properties:
                  Brands:
                    type: array
                    items:
                      type: object
                      properties:
                        Id:
                          type: string
                        Name:
                          type: string
                  PaintTypes:
                    type: array
                    items:
                      type: object
                      properties:
                        Id:
                          type: string
                        Name:
                          type: string
                  Glosses:
                    type: array
                    items:
                      type: object
                      properties:
                        Id:
                          type: string
                        Name:
                          type: string
                  Tags:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagResponse"
                  TagCategories:
                    type: array
                    items:
                      type: object
                      properties:
                        Id:
                          type: string
                        Name:
                          type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/csrf:
    get:
      summary: CSRFトークン取得
      description: CSRFトークンを取得します。状態変更系のAPIリクエスト時に使用します。
      tags:
        - Auth
      x-phase: [Phase1]
      responses:
        "200":
          description: CSRFトークン
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string

  /auth/google:
    get:
      summary: Googleログイン
      description: Googleアカウントを使用してログインします。GoogleのOAuthにChallengeします。
      tags:
        - Auth
      x-usecases: [UC-U-05]
      x-functions: [FR016]
      x-phase: [Phase3]
      x-number: [API-006]
      parameters:
        - name: returnUrl
          in: query
          required: false
          schema:
            type: string
            default: "/"
          description: 認証後にリダイレクトするローカルURL
      responses:
        "302":
          description: GoogleのOAuth認証ページにリダイレクト

  /auth/logout:
    post:
      summary: ログアウト
      description: |
        ユーザーをログアウトし、アプリ用Cookieを無効化します。
        CSRF 検証は条件付きです:
        - 認証 Cookie (`PlasticModelApp.Auth` / `access_token` / `refresh_token`) を送る場合は `X-CSRF-TOKEN` が必要
        - Bearer token のみ（認証 Cookie なし）の場合は CSRF トークン不要
      tags:
        - Auth
      x-usecases: [UC-U-05]
      x-functions: [FR017]
      x-phase: [Phase3]
      x-number: [API-008]
      parameters:
        - name: X-CSRF-TOKEN
          in: header
          required: false
          schema:
            type: string
          description: 認証 Cookie を送る場合に必要
      responses:
        "200":
          description: ログアウト成功。
        "403":
          description: 認証 Cookie 利用時に CSRF トークンが不足または不正
        "302":
          description: ログアウト後、指定されたURLにリダイレクト

  /auth/refresh:
    post:
      summary: セッション更新
      description: リフレッシュトークンを使用してアクセストークンを再発行します。
      tags:
        - Auth
      x-phase: [Phase3]
      responses:
        "200":
          description: セッション更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        "401":
          description: リフレッシュトークンが無効または期限切れ
        "403":
          description: 同一オリジンではないリクエスト

  /auth/me:
    get:
      summary: ログイン状態取得
      description: 現在のログイン状態とユーザー情報を取得します。
      tags:
        - Auth
      x-phase: [Phase3]
      responses:
        "200":
          description: ログイン状態
          content:
            application/json:
              schema:
                type: object
                properties:
                  isAuthenticated:
                    type: boolean
                  userId:
                    type: string
                    nullable: true
                  email:
                    type: string
                    nullable: true
                  role:
                    type: string
                    nullable: true

  /api/me/favorites:
    get:
      summary: 自分のお気に入り一覧取得
      description: ログインユーザーのお気に入り塗料一覧を取得します。
      tags:
        - Favorites
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      responses:
        "200":
          description: お気に入り一覧
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetMyFavoritesResult"
        "401":
          description: 未認証

  /api/me/favorites/{paintId}:
    post:
      summary: お気に入りに追加
      description: 指定した塗料をお気に入りに追加します。
      tags:
        - Favorites
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: paintId
          in: path
          required: true
          schema:
            type: string
      responses:
        "201":
          description: お気に入り追加成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyFavoriteResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証
    delete:
      summary: お気に入りから削除
      description: 指定した塗料をお気に入りから削除します。
      tags:
        - Favorites
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: paintId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: お気に入り削除成功
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証

  /api/me/memos:
    get:
      summary: 自分のメモ一覧取得
      description: ログインユーザーの塗料メモ一覧を取得します。
      tags:
        - Memos
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      responses:
        "200":
          description: メモ一覧
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetMyMemosResult"
        "401":
          description: 未認証
    post:
      summary: メモ作成
      description: 塗料メモを新規作成します。
      tags:
        - Memos
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMyMemoRequest"
      responses:
        "201":
          description: メモ作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyMemoResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証

  /api/me/memos/{memoId}:
    put:
      summary: メモ更新
      description: 既存のメモを更新します。
      tags:
        - Memos
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: memoId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMyMemoRequest"
      responses:
        "200":
          description: メモ更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyMemoResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証
    delete:
      summary: メモ削除
      description: 既存のメモを削除します。
      tags:
        - Memos
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: memoId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: メモ削除成功
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証

  /api/me/stocks:
    get:
      summary: 自分の在庫一覧取得
      description: ログインユーザーの塗料在庫一覧を取得します。
      tags:
        - Stocks
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      responses:
        "200":
          description: 在庫一覧
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetMyStocksResult"
        "401":
          description: 未認証

  /api/me/stocks/{paintId}:
    put:
      summary: 在庫更新
      description: 指定した塗料の在庫数を登録または更新します。
      tags:
        - Stocks
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: paintId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpsertMyStockRequest"
      responses:
        "200":
          description: 在庫更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyStockResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証
    delete:
      summary: 在庫削除
      description: 指定した塗料の在庫を削除します。
      tags:
        - Stocks
      security:
        - cookieAuth: []
      x-phase: [Phase3]
      parameters:
        - name: paintId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: 在庫削除成功
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 未認証

components:
  responses:
    BadRequest:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            Error:
              Status: 404
              Code: E-404-01
              Message: リソースが見つかりません
              Details:
                - Field: id
                  Issue: "指定されたIDのペイントが存在しません"
              Timestamp: "2023-10-01T12:00:00Z"

    InternalServerError:
      description: サーバー内部エラー
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            Error:
              Status: 500
              Code: E-500-01
              Message: サーバー内部エラーが発生しました
              Details: []
              Timestamp: "2023-10-01T12:00:00Z"

  schemas:
    ErrorResponse:
      type: object
      properties:
        Error:
          type: object
          properties:
            Status:
              type: integer
              example: 400
            Code:
              type: string
              example: E-400-01
            Message:
              type: string
              example: 不正なリクエスト
            Details:
              type: array
              items:
                type: object
                properties:
                  Field:
                    type: string
                    example: name
                  Issue:
                    type: string
                    example: missing required field
            Timestamp:
              type: string
              format: date-time
              example: "2023-10-01T12:00:00Z"

    PaintSearchCriteria:
      type: object
      properties:
        BrandIds:
          type: array
          items:
            type: string
        PaintTypeIds:
          type: array
          items:
            type: string
        GlossIds:
          type: array
          items:
            type: string
        TagIds:
          type: array
          items:
            type: string
        Sort:
          type: string
          enum:
            - ModelNumberAsc
            - ModelNumberDesc
            - NameAsc
            - NameDesc
          default: ModelNumberAsc
        Page:
          type: integer
          default: 1
        PageSize:
          type: integer
          default: 30
          maximum: 100

    PaintListResponse:
      type: object
      properties:
        Items:
          type: array
          items:
            type: object
            properties:
              Id:
                type: string
              Name:
                type: string
              ModelNumber:
                type: string
              Brand:
                type: string
              PaintType:
                type: string
              Gloss:
                type: string
              Hex:
                type: string
        Total:
          type: integer
        Page:
          type: integer
        PageSize:
          type: integer

    PaintResponse:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        ModelNumber:
          type: string
        Brand:
          type: string
        PaintType:
          type: string
        Gloss:
          type: string
        Price:
          type: number
        Description:
          type: string
        Hex:
          type: string
        RgbR:
          type: integer
        RgbG:
          type: integer
        RgbB:
          type: integer
        HslH:
          type: number
        HslS:
          type: number
        HslL:
          type: number
        ImageUrl:
          type: string
        Tags:
          type: array
          items:
            $ref: "#/components/schemas/TagResponse"
        CreatedAt:
          type: string
          format: date-time
        UpdatedAt:
          type: string
          format: date-time

    TagRequest:
      type: object
      properties:
        Name:
          type: string
        Category:
          type: string
        Hex:
          type: string
        Effect:
          type: string
          enum:
            - metallic
            - pearl
            - fluorescent
        Description:
          type: string
        UpdatedAt:
          type: string
          format: date-time
        CreatedAt:
          type: string
          format: date-time

    TagResponse:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        Category:
          type: string
        Hex:
          type: string
        Effect:
          type: string
          enum:
            - metallic
            - pearl
            - fluorescent
        Description:
          type: string
        UpdatedAt:
          type: string
          format: date-time
        CreatedAt:
          type: string
          format: date-time

    ColorSearchCriteria:
      type: object
      required:
        - R
        - G
        - B
      properties:
        R:
          type: integer
          minimum: 0
          maximum: 255
          description: 選択した色の赤成分 (0-255)。
        G:
          type: integer
          minimum: 0
          maximum: 255
          description: 選択した色の緑成分 (0-255)。
        B:
          type: integer
          minimum: 0
          maximum: 255
          description: 選択した色の青成分 (0-255)。
        Threshold:
          type: number
          format: double
          description: CIEDE2000 の距離の閾値。小さいほど類似度が高い。
          default: 5
          example: 5
        Page:
          type: integer
          default: 1
        PageSize:
          type: integer
          default: 30
          maximum: 100

    SimilarPaintListResponse:
      type: object
      properties:
        Items:
          type: array
          items:
            $ref: "#/components/schemas/SimilarPaintItem"
        Total:
          type: integer
        Page:
          type: integer
        PageSize:
          type: integer

    SimilarPaintItem:
      type: object
      properties:
        Id:
          type: string
        Name:
          type: string
        ModelNumber:
          type: string
        Brand:
          type: string
        PaintType:
          type: string
        Gloss:
          type: string
        Hex:
          type: string
        Similarity:
          type: number
          format: float
          description: CIEDE2000 による選択色との色差（小さいほど近い）。

    GetMyFavoritesResult:
      type: object
      properties:
        Favorites:
          type: array
          items:
            $ref: "#/components/schemas/MyFavoriteResult"

    MyFavoriteResult:
      type: object
      properties:
        PaintId:
          type: string
        CreatedAt:
          type: string
          format: date-time

    GetMyMemosResult:
      type: object
      properties:
        Memos:
          type: array
          items:
            $ref: "#/components/schemas/MyMemoResult"

    MyMemoResult:
      type: object
      properties:
        Id:
          type: string
        PaintId:
          type: string
        Body:
          type: string
        CreatedAt:
          type: string
          format: date-time
        UpdatedAt:
          type: string
          format: date-time

    CreateMyMemoRequest:
      type: object
      required:
        - PaintId
        - Body
      properties:
        PaintId:
          type: string
        Body:
          type: string

    UpdateMyMemoRequest:
      type: object
      required:
        - Body
      properties:
        Body:
          type: string

    GetMyStocksResult:
      type: object
      properties:
        Stocks:
          type: array
          items:
            $ref: "#/components/schemas/MyStockResult"

    MyStockResult:
      type: object
      properties:
        PaintId:
          type: string
        Quantity:
          type: integer
        UpdatedAt:
          type: string
          format: date-time

    UpsertMyStockRequest:
      type: object
      required:
        - Quantity
      properties:
        Quantity:
          type: integer
          minimum: 0

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: JWTアクセストークンがCookieに格納されます
